# 0. Conecta ao banco de dados
source(
  'scripts_dashboard_book_crm/0.conecta_banco.R', 
  echo=TRUE, 
  max.deparse.length=60
)

venda_encarte <- DBI::dbGetQuery(
  conn = con, 
  statement = "SELECT 
	DATA,
	v.LOJA,
	p.PRODUTO_ID AS COD_INTERNO,
	p.DESCRICAO_COMPLETA AS DESCRICAO_COMPLETA,
	s.secao AS NOME_SECAO,
	s.nomgrup as NOME_GRUPO,
	s.nom_sub as NOME_SUBGRUPO,
	v.TIPOIDENTCLIENTE,
	SUM(QUANTIDADE) AS QUANTIDADE_TOTAL,
	SUM(PRECO_TOTAL-ISNULL(DESCONTO,0)) AS PRECO_TOTAL,
	SUM(PRECO_TOTAL-isnull(DESCONTO,0))/SUM(QUANTIDADE) AS PRECO_MEDIO
FROM VM_INTEGRACAO.dbo.vw_propz v
LEFT JOIN VM_DATABSP.dbo.PRODUTOS p ON v.COD_INTERNO = p.PRODUTO_ID
LEFT JOIN [sgm].[dbo].[secao] s ON p.MERCADOLOGICO2=s.codsec AND p.MERCADOLOGICO3=s.grupo AND p.MERCADOLOGICO4=s.subgrupo
WHERE DATA >= '2023-09-29' AND p.PRODUTO_ID IN ('56329',
'12308',
'27529',
'52278',
'3193',
'9909',
'58093',
'8452',
'63410',
'56644',
'35815',
'68558',
'64859',
'32485',
'32486',
'170',
'69178',
'63774',
'61993',
'61996',
'69886',
'69887',
'67261',
'69699',
'69502',
'69503',
'56176',
'62936',
'58119',
'56737',
'52141',
'38089',
'38088',
'52829',
'176',
'69804',
'197',
'68603',
'12739',
'35074',
'20674',
'69482',
'70325',
'66311',
'61133',
'69838',
'62232',
'66984',
'66986',
'66985',
'65025',
'69704',
'70309',
'70308',
'66105',
'66402',
'69701',
'68099',
'62910',
'64184',
'60669',
'64185',
'60668',
'60667',
'68098',
'65997',
'65998',
'65999',
'54863',
'17304',
'11994',
'46287',
'55662',
'55661',
'55663',
'20177',
'47668',
'64914',
'60191',
'67534',
'65916',
'69889',
'69890',
'69891',
'69892',
'69893',
'69894',
'12994',
'68474',
'4665',
'5382',
'6943',
'10254',
'48890',
'61018',
'67410',
'67411',
'64089',
'67408',
'67409',
'47720',
'59058',
'59059',
'17321',
'14969',
'9769',
'9772',
'54007',
'65374',
'54008',
'65373',
'69350',
'55588',
'59100',
'61233',
'61234',
'23009',
'53595',
'32898',
'32897',
'412',
'3127',
'68461',
'2522',
'9032',
'4331',
'9802',
'9920',
'8544',
'4407',
'1951',
'3995',
'2396',
'2395',
'719',
'9601',
'4292',
'6810',
'15793',
'8086',
'8421',
'9150',
'8242',
'6541',
'61232',
'68409',
'6809',
'8235',
'1797',
'54589',
'3067',
'66344',
'66345',
'6929',
'6934',
'53803',
'51814',
'35119',
'40491',
'62612',
'3804',
'9526',
'258',
'260',
'64629',
'57428',
'27717',
'25233',
'30404',
'10310',
'10313',
'10311',
'10309',
'68963',
'68962',
'68964',
'64220',
'64223',
'69412',
'64222',
'64219',
'64218',
'57627',
'66967',
'61046',
'57628',
'60767',
'60766',
'64689',
'60216',
'68242',
'69747',
'56920',
'66443',
'3409',
'66695',
'70398',
'70399',
'70400',
'69798',
'53800',
'69786',
'69192',
'62803',
'62802',
'62801',
'57945',
'65713',
'62882',
'62884',
'63377',
'63378',
'14509',
'811',
'69793',
'66138',
'66139',
'45213',
'69045',
'47550',
'62815',
'60655',
'50632',
'46337',
'29049',
'29050',
'62104',
'70274',
'70273',
'70272',
'63576',
'63575',
'63577',
'20503',
'65669',
'65668',
'65667',
'28379',
'28380',
'45214',
'26452',
'54555',
'32876',
'69549',
'70271',
'69958',
'59717',
'59718',
'59716',
'59715',
'29862',
'8010',
'27273',
'70469',
'65593',
'56340',
'1883',
'38177',
'21893',
'41613',
'63744',
'54546',
'57771',
'57097',
'59234',
'59228',
'11175',
'66858',
'4858',
'19312',
'63745',
'30342',
'14996',
'68137',
'32776',
'68136',
'40014',
'35769',
'69870',
'68874',
'58636',
'61311',
'53713',
'17249',
'60067',
'43170',
'62316',
'55003',
'68392',
'65598',
'67933',
'67932',
'67930',
'68989',
'42219',
'42220',
'54476',
'58637',
'62398',
'62318',
'55005',
'35767',
'35768',
'39772',
'68871',
'69871',
'68872',
'58635',
'65648',
'61310',
'53712',
'68037',
'49143',
'51162',
'53714',
'59229',
'59230',
'52452',
'42206',
'4896',
'16254',
'36421',
'60065',
'41484',
'41483',
'62317',
'55004',
'68391',
'65596',
'14997',
'14998',
'27623',
'61939',
'62511',
'24862',
'65306',
'65308',
'65313',
'65310',
'61146',
'65321',
'31024',
'31025',
'31026',
'68476',
'68475',
'69825',
'69826',
'69827',
'69828',
'19818',
'59202',
'59201',
'68274',
'59200',
'70362',
'70432',
'65061',
'66009',
'66011',
'66013',
'66010',
'66571',
'66572',
'56964',
'22902',
'54338',
'54336',
'54337',
'59036',
'69356',
'68181',
'68182',
'69355',
'70229',
'65633',
'60804',
'40970',
'65418',
'65417',
'65175',
'12648',
'12647',
'57933',
'57932',
'57934',
'66169',
'65789',
'42355',
'48830',
'46126',
'46127',
'68836',
'68785',
'68787',
'68784',
'68786',
'66892',
'70077',
'70078',
'68788',
'65634',
'61043',
'63266',
'28468',
'60553',
'68951',
'399',
'64728',
'64726',
'64729',
'64727',
'66168',
'38583',
'21487',
'19816',
'43711',
'19817',
'70022',
'70023',
'70029',
'70024',
'70026',
'70025',
'70027',
'70028',
'70030',
'70031',
'70032',
'70033',
'70034',
'68292',
'68293',
'68294',
'65943',
'61145',
'68843',
'65942',
'61617',
'61618',
'61619',
'61620',
'59298',
'62798',
'65287',
'62799',
'62800',
'69325',
'9642',
'53848',
'41969',
'47059',
'68423',
'64368',
'64369',
'53845',
'54346',
'53846',
'53847',
'69766',
'69767',
'69768',
'69769',
'68822',
'68820',
'68821',
'38676',
'66605',
'70502',
'70503',
'70504',
'17485',
'27464',
'56954',
'10514',
'36414',
'34742',
'40173',
'67695',
'67696',
'24441',
'68350',
'63906',
'57535',
'68231',
'68232',
'70338',
'70337',
'57825',
'30655',
'45282',
'30654',
'45281',
'35374',
'63903',
'15601',
'56233',
'62549',
'67697',
'34736',
'14758',
'42407',
'42406',
'42408',
'42409',
'69980',
'69981',
'69979',
'69485',
'70501',
'35399',
'23912',
'66324',
'67967',
'67964',
'68227',
'66692',
'67656',
'67662',
'67658',
'67660',
'63900',
'63899',
'69475',
'47312',
'47314',
'69473',
'69474',
'67654',
'58339',
'48623',
'67652',
'67650',
'63555',
'28041',
'22307',
'22308',
'22306',
'38343',
'48314',
'36135',
'36132',
'36134',
'3413',
'63217',
'63218',
'60763',
'56301',
'56303',
'56304',
'56302',
'56299',
'62213',
'56300',
'63792',
'38838',
'70060',
'49185',
'70120',
'70119',
'70121',
'70249',
'3261',
'5379',
'2104',
'8768',
'3258',
'64555',
'63724',
'66865',
'63268',
'68693',
'67462',
'67461',
'68540',
'64907',
'64908',
'44047',
'44049',
'44048',
'67938',
'67935',
'67990',
'67989',
'64925',
'64229',
'64228',
'64924',
'68539',
'69366',
'69367',
'69368',
'69361',
'69840',
'69362',
'69363',
'31842',
'31843',
'31844',
'67946',
'57918',
'67945',
'56296',
'59197',
'56726',
'56728',
'56727',
'31340',
'31165',
'48244',
'32218',
'67338',
'54639',
'54640',
'66393',
'67337',
'66394',
'57360',
'55536',
'63979',
'64624',
'306',
'130',
'61485',
'69275',
'69276',
'63574',
'51816',
'9836',
'717',
'4343',
'67339',
'67340',
'62175',
'52797',
'142',
'10624',
'143',
'39588',
'59792',
'50214',
'35063',
'62495',
'66942',
'27053',
'67306',
'66995',
'10468',
'53702',
'12699',
'68046',
'51373',
'52679',
'59857',
'59858',
'53035',
'64634',
'48082',
'58608',
'55140',
'69809',
'65297',
'69523',
'57064',
'57065',
'52206',
'70428',
'57066',
'13368',
'66939',
'63755',
'63754',
'65644',
'1784',
'13594',
'37441',
'51735',
'55846',
'51300',
'51296',
'51299',
'65810',
'65809',
'52651',
'69895',
'69897',
'69896',
'27283',
'27281',
'53634',
'46169',
'38418',
'63757',
'67107',
'55553',
'39738',
'44724',
'70556',
'54446',
'70557',
'70416',
'59134',
'56900',
'68619',
'64137',
'66834',
'66914',
'66462',
'60270',
'58766',
'58767',
'58769',
'58765',
'64611',
'67511',
'67512',
'67514',
'67513',
'70554',
'70555',
'70552',
'70553',
'64613',
'64610',
'64998',
'64997',
'59013',
'59014',
'67280',
'59015',
'59016',
'59023',
'67519',
'64609',
'67030',
'67029',
'69467',
'70055',
'52095',
'67272')
GROUP BY DATA, v.LOJA, p.PRODUTO_ID, p.DESCRICAO_COMPLETA,s.secao,s.nomgrup,s.nom_sub,v.TIPOIDENTCLIENTE
ORDER BY SUM(PRECO_TOTAL) DESC, p.DESCRICAO_COMPLETA
;
  "
)

venda_encarte %>% 
  dplyr::mutate(TIPOIDENTCLIENTE = ifelse(TIPOIDENTCLIENTE !=0, 1,0),
                TIPOIDENTCLIENTE = ifelse(TIPOIDENTCLIENTE==1, 'IDENTIFICADO','NÃO IDENTIFICADO')) %>% 
  group_by(COD_INTERNO,DESCRICAO_COMPLETA, TIPOIDENTCLIENTE) %>% 
  dplyr::summarise(VENDA_TOTAL = sum(PRECO_TOTAL), QUANTIDADE_TOTAL = sum(QUANTIDADE_TOTAL)) %>%
  arrange(desc(DESCRICAO_COMPLETA)) %>% 
  writexl::write_xlsx('Análises Outubro - Guilherme/analise_produtos_encarte_v2.xlsx')

df_loja <- readxl::read_xlsx('dados/descricao_lojas.xlsx') %>% 
  dplyr::mutate(LOJA = as.numeric(LOJA))

## LOJA
venda_encarte %>% 
  dplyr::mutate(TIPOIDENTCLIENTE = ifelse(TIPOIDENTCLIENTE !=0 & !is.na(TIPOIDENTCLIENTE), 1,0),
                TIPOIDENTCLIENTE = ifelse(TIPOIDENTCLIENTE==1, 'IDENTIFICADO','NÃO IDENTIFICADO')) %>% 
  dplyr::filter(LOJA !=1) %>% 
  group_by(LOJA, TIPOIDENTCLIENTE) %>% 
  dplyr::summarise(VENDA_TOTAL = sum(PRECO_TOTAL), QUANTIDADE_TOTAL = sum(QUANTIDADE_TOTAL)) %>% 
  dplyr::left_join(df_loja, by = c('LOJA')) %>% 
  writexl::write_xlsx('Análises Outubro - Guilherme/analise_lojas_encarte_v2.xlsx')

rm(list=setdiff(ls(), "con"))
